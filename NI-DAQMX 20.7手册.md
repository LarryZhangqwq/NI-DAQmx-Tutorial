# NI-DAQMX 20.7手册

## 0. 入门

### 0.1 NI-DAQmx概述

NI-DAQmx是用于与NI数据采集(DAQ)设备通信并控制设备的驱动程序软件。它包含一个用途广泛的函数和VI库，可从LabVIEW或LabWindows/CVI中调用库函数，对NI设备进行编程。

Measurement＆Automation Explorer (MAX)和DAQ助手是随NI-DAQmx自动安装的应用程序。

可在在MAX或LabVIEW、SignalExpress、LabWindows/CVI、Measurement Studio等NI应用软件中打开DAQ助手。通过DAQ助手，可︰

- 创建和编辑任务及虚拟通道
- 向任务添加虚拟通道
- 创建和编辑换算
- 测试自定义配置
- 保存自定义配置
- 在NI应用软件中生成代码以用于自定义应用程序。
- 查看传感器的连线图。

### 0.2 查找范例

每个API均提供一组编程范例，以方便用户开发应用程序。用户可修改范例代码，然后将代码保存在应用程序中。用户可使用范例开发新的应用程序，或将范例添加至现有应用程序中。

使用NI-DAQmx仿真设备，无需安装硬件就可以运行范例。在MAX中，选择帮助 -> 帮助主题 -> NI-DAQmx，查看*NI-DAQmx的MAX帮助*，获取更多关于NI-DAQmx仿真设备的信息。

### 0.3 疑难解答

* https://www.ni.com/documentation/zhs/ni-daqmx/20.1/gettingstarted/troubleshooting/

## 1. 测量基础

### 1.1 测量系统概述－硬件和NI-DAQmx

<img src="/image/GUID-9D481B1D-EACA-4873-8632-99D6F735613E-5.5x8.5 - a5.png" alt="GUID-9D481B1D-EACA-4873-8632-99D6F735613E-5.5x8.5 - a5" style="zoom: 67%;" />

NI-DAQmx驱动软件中包含的应用软件可用于对NI测量设备编程（例如，配置、采集、生成和发送数据至NI测量设备）。使用NI-DAQmx可节省编程时间。应用程序（例如，LabVIEW、LabWindows™/CVI™和Measurement Studio）发送命令至驱动软件。例如，获取和返回热偶的读取值并显示和分析得到的数据。

通过NI应用软件或支持使用ANSI C接口调用动态链接库(DLL)的编程环境，可调用NI-DAQmx驱动程序。在任意编程环境中，DAQ应用均使用NI-DAQmx。

### 1.2 信号类型

<img src="/image/GUID-20D703F9-19D5-4B1D-88DC-04281846846B-5.5x8.5 - a5.png" alt="GUID-20D703F9-19D5-4B1D-88DC-04281846846B-5.5x8.5 - a5." style="zoom: 100%;" />

#### 1.2.1 模拟信号连接注意事项

**测量模拟信号前，必须确定信号源为接地或浮接，还必须考虑测量系统为差分、参考单端或非参考单端。**

* [接地信号源](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/groundsig/#GUID-A41EE540-F1EF-46F8-9D86-B72704F24216)
* [浮接信号源](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/floatsig/#GUID-EAC91D96-DE8A-47B7-BBEF-B53B37B190C2)
* [差分测量系统](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/diffmeassys/)
* [参考和非参考单端测量系统](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/refsingleended/)

#### 1.2.2 连接模拟输入信号

### 1.3 信号调理

传感器可生成用于测量物理现象（例如，温度、力、声音和光）的电信号。如需测量传感器的信号，必须将其转换为DAQ设备可读取的格式。例如，热电偶的输出电压很小且易被噪声干扰。因此，在转换为数字信号前，必须进行放大和滤波处理。

使信号适合数字化的过程称为*信号调理*。信号调理通常包括：放大, 线性化, 传感器激励, 隔离

#### 1.3.1 放大

通过增大信号相对于噪声的幅度，提高数字化信号的精度。使最大电压变化等于ADC或数字化仪的最大输入范围，可获得尽可能高的准确性。系统应通过最接近信号源的测量设备放大低电平信号。

<img src="/image/GUID-3865E721-F72F-46FF-8CF2-512BB75F12F4-5.5x8.5 - a5.png" alt="GUID-3865E721-F72F-46FF-8CF2-512BB75F12F4-5.5x8.5 - a5." style="zoom: 100%;" />

如通过测量设备放大信号，则测量和数字化的信号中可能包含由导线引入的噪声。在接近信号源的位置通过SCXI模块放大信号，可减少噪声对被测信号的影响。

**Note: 应使用屏蔽式电缆或双绞线电缆。通过减小电缆长度可降低导线引入的噪声。使信号连线远离AC电源电缆和显示器可减少频率为50至60 Hz的噪声。**

#### 1.3.2 线性化

通过软件使传感器产生的信号线性化，换算后的电压可用于物理现象。例如，通常，热电偶10 mV的电压变化并意味着温度的变化为10。但是，通过软件或硬件的线性化处理，应用中的热电偶值可换算为相应的温度变化。绝大多数传感器具有用于说明传感器换算关系的线性化表格。

#### 1.3.3 传感器激励 

信号调理系统可为某些传感器生成激励。应变计和RTD需要外部电压和电流激励电路，然后开始测量物理现象。激励类似于收音机用于接收和解码音频信号所需的电源。许多测量设备可为传感器提供激励。关于设备是否可生成激励，见设备文档

#### 1.3.4 隔离

信号通常会超出测量设备可处理的范围。尝试测量过大的信号可导致测量设备损坏或人身伤害。通过*隔离*信号调理技术可防止人体和测量设备接触过大的电压。信号调理硬件可降低较高的共模电压，获取测量设备可处理的电压信号。通过隔离可避免接地电势差对设备的影响。

### 1.4 常见传感器

不同的应用使用不同的传感器。常见的传感器包括：应变计、热电偶、热电阻、角度编码器、线性编码器、基于电桥的传感器以及电阻式温度检测器(RTD)。

* https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/cmmnsensor/

### 1.5 控制概述

通常，控制应用中包含一个或多个需控制的过程变量（例如，温度）。传感器可测量动态系统中的过程变量并为应控制应用提供数据。设定点为过程变量要达到的值。比较器可判断过程变量和设定点之间的差。如差不为零且系统判断该值足够大， 补偿器可处理该值并通过执行器的输出驱动系统接近设定点。

<img src="/image/GUID-74BFB5ED-CE8E-4CB7-8436-830393A22A26-5.5x8.5 - a5.png" alt="GUID-74BFB5ED-CE8E-4CB7-8436-830393A22A26-5.5x8.5 - a5" style="zoom: 100%;" />

#### 1.5.1 比例积分微分(PID)

比例积分微分(PID)算法是工业中最常使用的控制算法。通常，PID用于加热和冷却系统、液面监控、流控制和压力控制应用。在PID控制中，必须指定过程变量和设定点。过程变量是要控制的系统参数（例如，温度、压力和流量），设定点是要控制的参数值。PID控制器可确定控制器的输出值（例如，加热器的功率或值位置）。控制器使用控制器输出值控制系统，使过程变量接近设定点的值。

#### 1.5.2 实时

实时是指及时响应。对于非实时系统，无法确定响应发生的时间，操作完成的时间可能早于或晚于预期时间。换句话说，实时系统具有确定性，可保证操作在指定时间内发生。实时系统是可预期的。

对于实时系统，所有部分都必须是实时的。例如，即使程序运行在实时操作系统上，也不意味着程序具有实时特性。程序可能依赖某些非实时动作（例如，文件I/O），导致程序无法实时运行。

#### 1.5.3 循环周期时间

许多应用（例如，控制应用）需使用周期性实时操作系统。周期的开始和结束之间的时间*T*称为*循环周期时间*或采样周期。1/T为循环速率或采样率。即使在实时操作系统中，循环周期也可能变化，但始终小于最大抖动。

#### 1.5.4 控制应用中的抖动

对于控制应用，循环时间与期望时间的差称为抖动。循环时间与期望时间差的最大值称为最大抖动。<img src="/image/GUID-50BF3221-1F1B-4804-8623-CABB7E7FE044-5.5x8.5 - a5.png" alt="GUID-50BF3221-1F1B-4804-8623-CABB7E7FE044-5.5x8.5 - a5" style="zoom:50%;" />

实时系统中的抖动是固定的。例如，安全气囊必须在碰撞发生后的1秒内打开，因此最大抖动为固定值。非实时系统中的抖动不是固定的，变化范围较大。例如，等待公交车。按照计划，公交车应在上午11:00到达，但实际到达时间第一天为上午11:05，第二天为上午11:30，第三天无法到达。对公交车的延误时间没有限制。

#### 1.5.5 事件响应

事件响应应用需要在确定的时间内对发生的事件进行响应。例如，监视引擎的温度。在引擎温度过高时，降低引擎运行的速度。事件是指引擎温度超出预设上限，响应是指降低引擎运行速度。另一个实例来自生产制造过程。在生产线上，系统在检测到零件将要进行一道工序（事件）时，将获取读数或对零件执行操作（响应）。如系统在一段时间内没有检测到零件或没有对零件的出现产生响应，生产线将产生次品零件。

## 2. NI-DAQmx重要概念

### 2.1 NI-DAQmx通道和任务

* **虚拟通道（通道）**，是将实体通道和通道相关信息（范围、接线端配置、自定义换算等格式化数据信息）组合在一起的软件实体。任务是具有定时、触发等属性的一个或多个虚拟通道。
  * 通过“DAQmx创建虚拟通道”函数/VI创建的虚拟通道是局部虚拟通道，只能在任务中使用。使用该函数，可选择虚拟通道的名称。该名称将用于NI-DAQmx的其他位置，用于指代该虚拟通道。
  * 如使用DAQ助手创建虚拟通道，可在其他任务中使用这些虚拟通道，并在任务之外引用虚拟通道。因为这些虚拟通道是全局虚拟通道，可用于多个任务。可使用NI-DAQmx API或DAQ助手选择全局虚拟通道，并将其加入至任务。如将一条全局虚拟通道添加至若干个任务，然后使用DAQ助手修改这个全局虚拟通道，改动将应用于所有使用该全局虚拟通道的任务。全局虚拟通道的改动生效前必须先保存改动。
* **实体通道**是测量和发生模拟信号或数字信号的接线端或管脚。信号物理通道可包括一个以上接线端，例如，差分模拟输入通道，或8线数字端口。设备上的每个实体通道都有唯一的符合NI-DAQmx实体通道命名规范的名称（例如，SC1Mod4/ai0, Dev2/ao5, Dev6/ctr3）。

#### 2.1.1 通道：物理、虚拟、局部虚拟和全局虚拟

##### 2.1.1.1 使用API创建虚拟通道

**问题：**

创建一个NI-DAQmx虚拟通道，测量50° C - 200° C之间的温度。将M系列设备配置为Dev1，将J型热电偶连接至设备上的通道0。使用LabVIEW或LabWindows™/CVI™写一个应用程序。

**解答：**

1. 调用LabVIEW中的“DAQmx创建虚拟通道”VI的AI温度TC实例在LabWindows/CVI中是``DAQmxCreateAIThrmcplChan``函数）。
2. 使用设备上的``Dev1/ai0``作为连接热电偶信号的实体通道。
3. 指定虚拟通道的名称为``myThermocoupleChannel``。
4. 选择相应的热电偶类型和范围输入值。NI-DAQmx将把这些属性应用至虚拟通道。

##### 2.1.1.2 虚拟通道的类型

根据信号的类型（模拟、数字、计数器）和方向（输入、输出），可创建不同类型的虚拟通道。虚拟通道可以是全局虚拟通道或局部虚拟通道。关于函数/VI的详细信息，请参考ADE的相关帮助。

- **模拟输入通道**—模拟输入通道使用各种传感器测量不同的物理现象。创建的通道类型取决于传感器以及测量现象的类型。例如，可创建热电偶测量温度的通道、测量电流电压的通道、测量带激励电压的通道，等等。

- **模拟输出通道**—NI-DAQmx支持两种类型的信号，电流信号和电压信号。如设备测量的是其他信号，可将测得的信号进行转换得到电压或电流信号。

- **数字输入/输出通道**—对于数字通道，可创建基于线和基于端口的数字通道。基于线的通道可包含设备一个或多个端口的一条或多条数字线。读取护哦些如基于数字线的通道不会影响硬件上的其他数字线。可将一个端口中的数字线在多条通道中使用，并在一个或多个任务中同时使用这些通道，但是某条通道中的线必须全是输入线或输出线。另外，任务中的所有通道必须是输入通道或输出通道。有些设备还规定端口中的线必须都是输入线或输出线。关于设备的详细信息，请查阅设备文档。

  基于端口的通道表示设备上的一组数字线。读取或写入端口将影响端口中的所有数字线。端口中所有线的数量（端口宽度）是一个硬件参数，通常从8线（MIO设备）到32线（SCXI数字模块）不等。

- **计数器输入/输出通道**—NI-DAQmx支持不同计数器测量和生成类型的输入和输出。关于计数器测量的常见应用，见NI-DAQmx中计数器的组成。

##### 2.1.1.3 物理通道语法

###### 物理通道名称

物理通道的名称有**设备标识符、斜杠(/)和通道标识符**组成。例如，如物理通道是``Dev1/ai1``，设备标识符是``Dev1``，通道标识符是``ai1``。MAX根据设备在系统中安装顺序的前后为设备分配标识符，例如，``Dev0、Dev1``等等。也可在MAX中为设备分配设备标识符。

对于模拟I/O和计数器I/O，通道标识符由通道类型（**模拟输入ai，模拟输出ao，计数器ctr**）和通道编号组成，如下所示：``ai1 ctr0``

对于数字I/O，通道标识符指定了一个端口，包括了端口中的所有线：``端口0``

通道标识符可指定端口中的线：``port0/line1``

所有线都具有唯一的标识符。所以，不用说明线归属的端口即可指定一条数字线。例如，在有4个8位端口的设备上，``line31``等同于``port3/line7``。

###### 物理通道范围

如要指定一个物理通道的范围，在两个通道编号或物理通道名称的编号之间使用冒号分隔：

``Dev1/ai0:4``or ``Dev1/ai0:Dev1/ai4``

对于数字I/O，在两个端口编号之间用冒号分隔，指定一个端口范围。

``Dev1/port0:1``

可指定一个数字线的范围：

``Dev1/port0/line0:4``

``Dev1/line0:31``

可反向指定通道范围：

``Dev1/ai4:0``

``Dev1/ai4:Dev1/ai0``

``Dev1/port1/line3:0``

###### 物理通道列表

使用逗号在列表中分隔物理通道名称和范围，如下所示：

``Dev1/ai0, Dev1/ai3:6``

``Dev1/port0, Dev1/port1/line0:2``

##### 2.1.1.4 数字线、端口和端口宽度

数字线和端口是数字输入/输出系统的重要部分。

- **线**—一条线就是一个独立的信号。线表示一个实体的接线端。线上的数据叫做“位”，是二进制的0或1。线和位基本上是可以互换的术语。例如，8比特端口与8线端口含义相同。
- **端口**—端口是数字线的集合。通常情况下，数据线都被组合为8位或32位端口。
- **端口宽度**—端口宽度指端口中线的数量。例如，一个8线端口的端口宽度为8。

##### 2.1.1.5 生成通道名称

通过NI-DAQmx API创建局部虚拟通道时，如用户不提供局部虚拟通道的名称，NI-DAQmx将会为通道自动分配名称

| 物理通道名称 | 分配的名称 | 生成的局部虚拟通道名称         |
| :----------- | :--------- | :----------------------------- |
| Dev1/ai0:1   | —          | Dev1/ai0, Dev1/ai1             |
| Dev1/ai0:7   | "foo"      | foo0, foo1, ..., foo7          |
| Dev1/ai0:7   | "foo31"    | foo31, foo32, ..., foo38       |
| Dev1/ai0:7   | "foo 123"  | foo123, foo124, ..., foo130    |
| Dev1/ai0:7   | "a0:3, b"  | a0, a1, a2, a3, b0, b1, b2, b3 |

##### 2.1.1.6 为通道、任务和换算命名

通道、任务和换算的命名需符合下列要求：

- 仅使用字母和数字字符。

- 不要使用非字母数字字符，下列特例除外：

  - NI-DAQmx 7.4及更高版本允许在通道、任务和换算的名称中使用连字符。
  - 允许使用空格。
  - 可在通道、任务或换算名称中使用下划线，但是下划线不能作为名称的首字符，如_Dev1。

  **注：**

  创建通道、任务和换算时，可使用其他非数字字母类字符。但是将配置导入其他系统，尤其是其他语言的系统时，配置可能失效。

- 设备名称不能多于256个字符。

##### 2.1.1.7 冷端补偿通道

内置的冷端补偿(CJC)通道。每经过一个采样时钟边沿，读取一次CJC通道。

相关主题：[采样时钟](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/sampclock/)

#### 2.1.2 NI-DAQmx任务

任务是一个或多个虚拟通道定时、触发等属性的集合。从概念上来说，任务就是信号测量或信号发生。任务中的所有通道的I/O类型必须相同，例如，模拟输入、计数器输出，等等。但是，任务可包含不同测量类型的通道，例如，测量温度的模拟输入通道和测量电压的模拟输入通道。对于大多数设备，一次只能运行子系统的一个任务；部分设备可同时运行多个任务。在一些设备上，一个任务中可以包括来自多台设备的通道。按照下列步骤进行测量或生成任务：

1. 创建或加载一个任务。可使用DAQ助手交互式创建任务，或在ADE（LabVIEW或LabWindows/CVI）中通过编程创建任务。
2. 如有需要，配置通道、定时和触发属性。
3. 如有需要，进行若干任务状态转换，使任务就绪。
4. 读取或写入采样。
5. 清除任务。

如实际需要，请重复步骤2至步骤4。例如，读取或写入采样后，可重新配置虚拟通道、定时和触发属性，然后根据新的配置读取和写入其他采样。

如要将属性设置为除默认值以外的其他值以保证任务成功执行，程序每次执行时都必须重新设置这些属性。例如，如运行的程序将属性A设置为非默认值，然后再运行一个不设置属性A的程序，第二个程序将使用属性A的默认值。避免该重复操作的唯一方法时使用DAQ助手创建虚拟通道和任务。

##### 2.1.2.1 通过API创建任务

**问题：**

创建一个NI-DAQmx任务测量50°C-200°C之间的温度，将M系列设备配置为设备1，连接J型热电偶至设备的通道0。每秒钟采集温度10次，采集10,000个数据。使用LabVIEW或LabWindows/CVI写一个应用程序。

**解答：**

1. 调用LabVIEW中的“DAQmx创建虚拟通道”VI的AI温度TC实例（在LabWindows/CVI中是``DAQmxCreateAIThrmcplChan``函数）。
2. 使用设备上的``Dev1/ai0``作为连接热电偶信号的物理通道。
3. 指定虚拟通道的名称为``myThermocoupleChannel``。
4. 选择相应的热电偶类型和范围输入值。NI-DAQmx将把这些属性应用至虚拟通道。
5. 调用LabVIEW中“DAQmx定时”VI的采样时钟实例（或LabWindows/CVI中的``DAQmxCfgSampClkTiming``函数），指定**采样率**为10 Hz，**采样模式**为有限(finite)采样。
6. 调用“DAQmx开始任务”VI（LabWindows/CVI中的``DAQmxStartTask``函数）。
7. 调用“DAQmx读取”VI的模拟1D DBL 1通道N采样实例（``LabWindows/CVI中的DAQmxReadAnalogF64``函数），指定**每通道采样数**为10,000。
8. 当采集完所需的样本数据后，调用“DAQmx停止任务”VI（LabWindows/CVI中的``DAQmxStopTask``函数）。
9. 调用“DAQmx清除任务”VI（LabWindows/CVI中的``DAQmxClearTask``函数）。

至此，使用局部虚拟通道``myThermocoupleChanne``l的``myTemperatureTask``任务创建完毕。

##### 2.1.2.2 使用“开始任务”函数/VI

调用“开始任务”函数/VI可显式地开始一个任务。进行其他隐式开始任务的操作时，任务会自动开始。例如，调用“读取”或“写入”函数/VI可能会隐式地开始一个任务。指定显式或隐式开始任务，取决于任务的操作。默认情况下，**单点读取函数和写入函数会自动开始一个任务**。

**相关主题**

- [“已就绪”状态](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/committedstate/)
- [“运行”状态](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/runningstate/)
- [任务状态模型](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/taskstatemodel/)
- [“已验证”状态](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/verified/)

**开始一个有限测量任务：**

* 如指定了执行有限测量的任务，则无需调用开始任务函数/VI，也不需要更改DAQmx读取函数/VI的默认行为。调用读取函数/VI开始任务并执行有限测量，并在读取最后一个采样后停止任务。调用读取操作前，任务返回其状态。但是，如要在任务结束后进行额外的读取操作（要读取缓冲区更早存入的数据），默认操作是不够的，原因有二：
  1. 任务返回至验证状态，无法访问采样。
  2. 再调用“读取”函数/VI会启动新的读取操作，而不是从完成的操作中继续读取。
* 在该情况下，调用控制任务函数/VI，将**动作**参数设置为“就绪”。然后，在进行初始读取操作之后和后续操作之前，将自动开始读取属性设置为FALSE。

**开始一个连续测量任务：**

对于连续测量，调用“开始任务”函数/VI，进行所需的读取操作，然后调用“停止任务”函数/VI停止连续测量。如在循环中进行读取操作，无论读取操作是单采样读取、按需读取，还是多采样硬件定时读取，请在进入循环之前调用“开始任务”函数/VI，在离开循环之后调用“停止任务”函数/VI。

**开始模拟输出任务：**

写入函数/VI的操作较为复杂。调用写入函数/VI的结果是任务至少转换为已就绪状态。任务是否转换至运行状态取决于**自动开始**参数的值。

对于单采样写入操作，调用写入函数/VI的单采样实例。该调用也启用了任务，写入单个采样，最后停止任务。对于多采样按需写入操作，调用写入函数/VI，并将**自动开始**参数设置为真，其默认值为假。该调用也启用了任务，写入多个采样，最后停止任务。

对于多采样硬件定时写入操作，应先调用“写入”函数，写入要生成的样本，显式调用“开始任务”，调用“结束前等待”函数/VI等待采样生成完毕，然后显式调用“停止任务”函数/VI。

如将“写入”函数/VI的**自动开始**参数设置为真（主动设置或使用单点写入函数），硬件定时生成可能会失败，因为写入的采样在波形生成时还未传递到设备。进行硬件定时生成时，开始任务之前始终写入部分波形

**改进“开始任务”函数/VI的性能：**

下面是部分需显式调用“DAQmx开始任务”函数/VI和“DAQmx停止任务”函数/VI的情况：在循环中调用“读取”或“写入”函数/VI时，在进入循环之前调用“开始任务”函数/VI，在离开循环之后调用“停止任务”函数/VI，可明显提高运行速度。如在进入循环之前未调用“开始任务”函数，任务在进行读取或写入操作前必须从当前状态转换为“运行”状态。读取或写入操作完成后，任务必须从“运行”状态恢复至原来的状态。每次循环中都将发生这些转换，会消耗大量时间。

##### 2.1.2.3 中止任务

导致任务中止的几种情况：

- 如要显式中止任务，可调用DAQmx控制任务函数/VI，且**动作**参数设置为“中止”。通常，中止任务并非正常的操作。应将其用于特殊情况。
- 在LabVIEW中，单击**中止执行**按钮可中止任务。这样做会导致在该VI层次结构中创建的所有任务被中止，然后被清除。
- 如从系统中删除设备，当前正在使用该设备资源的所有任务均会中止。
- 如调用DAQmx重置设备函数/VI将设备恢复到初始配置，则当前使用该设备资源的所有任务均会中止。

任务被中止时，它将返回“已验证”状态。如任务正在运行，它将立即停止并随即返回未预留状态。任务被中止后，可继续使用该任务。但继续指定的操作前，可能需要将任务转换回它的上一个状态。

#####  2.1.2.4 使用“任务完成”函数/VI

如要在应用程序的一个部分监测另一部分任务的进度，可使用“任务完成”函数/VI。

总而言之，如不需要读取和写入采样，而是需要监测错误时，可在连续测量和生成中使用“任务完成”函数/VI

##### 2.1.2.5 使用“结束前等待”函数/VI

可能需要调用“结束前等待”函数确保操作在任务停止前结束。

最常见的范例是有限次生成。如开始一个进行有限次信号生成的任务，然后立即停止任务，停止任务时生成可能没有完成。生成没有按照预期完成。要保证有限次信号生成按照预期完成，在停止任务前调用“结束前等待”函数。“结束前等待”函数执行后，有限次生成任务完成，然后任务停止。

一般情况下，“结束前等待”函数通常与有限次测量或生成任务一起使用。

##### 2.1.2.6 任务何时完成？

如测量或生成是有限的，采集或生成最后采样或调用“停止任务”函数/VI时任务即告完成。如测量或生成为连续的（包括按需定时）或启用重新触发，直到调用“停止任务”函数/VI，任务才告完成。另外，如生成或测量时发生了一个严重错误，或中止测量或生成时，任务即完成。检查错误和警告，确保任务成功完成。

##### 2.1.2.7 任务状态模型

###### 2.1.2.7.1: "未验证"状态

创建或加载任务后，任务即为未验证状态。在该状态下，可配置任务的定时、触发和通道属性。

###### 2.1.2.7.2: “已验证”状态

任务从未验证状态至验证状态转换时，NI-DAQmx将检查任务的定时、触发和通道属性。调用“控制任务”函数/VI，**动作**接线端设置为“验证”，可完成上述状态转换。NI-DAQmx会立即检查和验证一些属性的值是否合法，但是有些属性的值无法立即检查和验证，因为这些属性的值依赖于其他属性和使用的设备。NI-DAQmx在验证转换时检查这些属性的值，并报告检测中发现的非法属性值。如NI-DAQmx没有发现非法值，任务成功验证并进入“验证”状态。否则，任务将停留在未验证状态。

在某些情况下，NI-DAQmx会强制转换属性的值，使任务通过验证，而不是生成一个错误。当属性上设置的值不能精确满足，但是对原值的修改不会明显影响任务时，NI-DAQmx会强制修改原值。

###### 2.1.2.7.3: "已保留"状态

任务从验证状态转换为保留状态时，任务进行某个操作时所需的资源会被独占。这些资源可以是设备上的时钟或通道、PXI机箱上的触发线，或计算机的缓存。保留这些资源可防止其他任务占用这些资源，以免干扰当前任务的执行。调用“控制任务”函数/VI，**动作**接线端设置为“保留”，可完成上述状态转换。如果资源被其他任务占用，转换将失败。如果任务可访问其使用的所有资源，任务就可成功保留并转换至“保留”状态。否则，任务将停留在验证状态。

###### 2.1.2.7.4: "已就绪"状态

任务转入“已就绪”状态状态时，NI-DAQmx会改变资源的某些设置。这些设置可能是时钟的速率、设备通道的输入限制、PXI机箱触发线的方向、计算机缓冲区的大小，等等。有些设置，例如，采样计数器，无法在任务转换至“已就绪”状态状态时改变。因为这些设置在任务开始时改变。任务进入“已就绪”状态状态，即任务从“已保留”状态转为“已就绪”状态状态。调用“控制任务”函数/VI，**动作**接线端设置为“就绪”，可完成上述状态转换。总而言之，就绪转换不会失败。失败属于意外情况。如失败了，任务就会保持“已保留”状态。如程序改变了任务相关的资源设置，任务即成功转入“已就绪”状态状态。

###### 2.1.2.7.5: "运行"状态

当任务开始执行指定操作时，任务从“已就绪”状态转为“运行”状态。调用“开始任务”函数/VI可完成上述转换。开始一个任务并不意味着开始采集样本或生成波形。指定定时和触发属性，直到调用“读取”函数/VI才开始采集样本，或直到检测到触发才生成波形。总而言之，开始转换不会失败。失败属于意外情况。如失败了，任务就会保持“已就绪”状态。当任务开始执行指定操作时，任务成功开始并转换至运行状态。

###### 2.1.2.7.6: “运行”状态至“已就绪”状态

任务从“运行”状态转换为“已就绪”状态时，任务将停止执行指定操作。调用“停止”任务函数/VI实现上述转换。可能指定了定时和触发属性，转换发生前所有采样已采集完毕。对于输出操作，最后写入的值通常在任务停止后继续生成。在这种情况下，尽管不会采集更多样本，任务在转换发生之前仍在运行状态。总而言之，停止转换不会失败。失败属于意外情况。如失败了，任务就会返回“保留”状态。如果任务停止了，任务将转换为“已就绪”状态。

###### 2.1.2.7.7: “已就绪”状态至“已验证”状态

当进行特定操作的任务资源被释放后，任务从“已就绪”状态转为“已验证”状态。这些资源可以是设备上的时钟或通道、PXI机箱上的触发线，或计算机的缓存。调用“控制任务”函数/VI，**动作**接线端设置为“取消保留”，可完成上述状态转换。任务释放所有资源后，就会回到“已验证”状态。

###### 2.1.2.7.8: 显式和隐式状态转换

何时使用显式状态转移，何时使用隐式状态转移取决于所使用的系统。

**下面列出了使用显式状态转移的情况：**

- **验证**—如用户通过在应用程序中设置各种通道、定时和触发属性配置一个任务，请通过显式方式验证任务，以告知用户是否将属性设为有效值。
- **保留**—如下列条件为真，请选择通过显式方式保留一个任务：应用程序中包含使用相同资源的多个任务，某个任务反复执行操作，保证任务在连续操作开始之后其他任务不占用相关的资源。独占性地保留一个任务将占用任务要用到的资源，确保其他任务无法使用这些资源。例如，如应用程序包含两个进行一系列测量的任务，要保证一个任务在另一个任务完成后才开始，可将这两个任务在开始执行测量之前通过显式保留任务。
- **就绪**—如应用程序通过反复开始和停止一个任务进行多采样测量或生成，请显式将任务转入“就绪”状态。独占性地使任务进入“就绪”状态，需占用任务的资源，并改变这些资源的一些设置。独占性地使任务进入“就绪”状态，这些操作仅进行一次，而不是每次任务开始均进行一次操作，以减少开始任务所需的时间。例如，如应用程序重复进行有限次硬件定时测量，在重复进行测量之前使任务进入“就绪”状态，开始任务所需的事件就会明显减少。如要在任务停止后继续读取额外样本，也需要使任务进入“就绪”状态。关于更多信息，见使用“开始任务”函数/VI。
- **开始**—如任务反复进行读取或写入操作，显式地开始该任务。开始任务即保留了任务相关的资源，改变某些资源的相关设置，以及开始进行指定操作。显式开始任务时，这些操作仅进行一次，而不是每次读取或写入操作时都保留一次资源。该过程可显著减少进行读取或写入操作所需的时间。例如，如应用程序反复进行单点软件定时读取操作，如进行反复读取操作之前显式地开始任务，每次读取操作所需的时间会明显减少。

#### 2.1.3 使用DAQ助手创建通道和任务

可从NI应用软件或MAX中打开DAQ助手。DAQ助手是用于配置通道、任务和换算的图形化界面。

打开DAQ助手之后，按照向导的说明创建任务或通道。向导完成后，可配置测量的换算，如果必要，还可配置定时和触发。

**相关主题**

[选择使用API或DAQ助手](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/daqversusapi/)

**LabVIEW: **

在LabVIEW中，有若干种方法可以打开DAQ助手。常见的方法有下列几种：

- 从Express输入选板种选择DAQ助手Express VI。
- 使用DAQmx任务名称控件打开DAQ助手。
- 按照*LabVIEW帮助*中的*NI-DAQmx与LabVIEW项目的配合使用*，在LabVIEW项目中打开DAQ助手。

**LabWindows/CVI: **

在LabWindows/CVI中，选择**Tools»Create/Edit DAQmx Tasks**。单击DAQmx LoadTask函数选板的**Task Name**控件，选择**New Task**，打开DAQ助手。

**Measurement Studio:**

在Measurement Studio中，打开Visual Studio .NET并选择**Project»Add New Item**打开Add New Item对话框。在Categories栏中选择**Measurement Studio»Assistants**。在Templates栏中选择**DAQmx Task Class**。

**MAX:**

在MAX中，右键单击**数据邻居**并从快捷菜单中选择**新建**。在**新建**窗口选择**NI-DAQmx任务**或**NI-DAQmx全局虚拟通道**，然后单击**下一步**。

**Signal Express:**

在SignalExpress中，添加DAQmx Acquire或DAQmx Generate步骤。

#### 2.1.4 选择使用API或DAQ助手

创建一个新的应用程序时，可选择使用DAQ助手或API。

**使用DAQ助手的优点：**

- 无需编程。只需交互地配置通道、定时、触发和换算。
- DAQ助手缩短了开发时间。几分钟就可完成一个应用程序。
- 如通过DAQ助手创建了一个应用程序，后又需要其一些隐藏的功能，可从NI的应用程序开发环境（LabVIEW、LabWindows/CVI或Measurement Studio）中基于DAQ助手，生成等效的API代码。

**使用API的优点：**

- API中具有DAQ助手中隐藏的一些高级功能。
- API具有更好的灵活性，用户可基于实际需要使用API自定义应用程序。
- API能更好地控制应用程序的性能。

### 2.2 定时和触发

定时和触发是NI-DAQmx中的重要概念。时钟部分介绍了时钟和握手。触发部分介绍了开始触发和参考触发，以及其他常见的触发类型。例如，模拟边沿触发、数字边沿触发、等等。

#### 2.2.1 硬件定时和软件定时的比较

软件定时或硬件定时用于控制信号生成的时间。

**硬件定时**，例如，设备上的时钟（数字信号），控制信号生成的速率。

**软件定时**就是由操作系统和软件来控制采样生成，而不是由测量设备来控制。

硬件时钟运行远比软件快。硬件时钟比软件更为精确。

在NI-DAQmx中，**选择采样时钟定时函数/VI来确定硬件定时**，或**设置采样时钟的采样定时类型属性**。**如不进行上述设置，将采样定时类型属性设置为按需采集，表示已选择软件定时**。

##### 2.2.1.1 时钟

周期性的数字边沿可当作时钟用来计时。**采样时基时钟和20 MHz时基时钟表示消耗的时间**，用于将信号按时间对齐。时钟，顾名思义通常不像触发一样引起某个动作。采样时钟例外。

下列是DAQ设备常用的时钟。关于设备上时钟的详细信息，见设备的说明文档。

- **AI转换时钟**—多路复用设备上直接引发ADC转换的时钟。与设备最快的AI转换时钟速率相比，默认AI转换时钟另需要通道间10µs的稳定时间。当采样时钟频率过高而导致无法使用10 µs额外稳定时间时，默认AI转换时钟频率将使用采样时钟频率所允许的最高稳定时间。如一个任务中有多台设备，即使这些设备最大允许的AI转换时钟速率可能不同，任务中的所有设备均使用相同的额外稳定时间。
- **AI转换时钟时基**—被分成更精确的时间精度，用作AI转换时钟。
- **AI采样时钟**—控制采样时间间隔的时钟。采样时钟每滴答一次（生成一次脉冲），即在每条通道上采集一个样本。
- **AI采样时钟时基**—作为AI采样时钟源的板载时钟。AI采样时钟时基被划分为更细的精度，生成AI采样时钟。
- **计数器时基**—连接至计数器源接线端的时钟（例如，``Ctr0Source``）。
- **DI采样时钟**—控制采样时间间隔的时钟。采样时钟每滴答一次（生成一次脉冲），即在每条通道上采集一个样本。
- **DO采样时钟**—控制采样时间间隔的时钟。采样时钟每滴答一次（生成一次脉冲），即在每条通道上采集一个样本。
- **DO采样时钟时基**—作为DO采样时钟源的板载时钟。DO采样时钟时基被划分为更细的精度，生成DO采样时钟。
- **主时基**—设备上其他计数器时钟的板载时钟。主时基被划分为更细的精度，用于生成更慢的时钟测量消耗的时间。该时基是板载时钟作为AI采样时钟时基、AO采样时钟时基和计数器时基的源。
- **12.8 MHz时基**—主时基的板载时钟源，由此派生出其他时基。该时基用于在机箱之间同步任务。
- **13.1072 MHz时基**—主时基的板载时钟源，由此派生出其他时基。该时基用于在机箱之间同步任务。
- **20 MHz时基**—主时基的板载时钟源，由此派生出其他时基，如设备不支持80 MHz时基。否则，通过将80 MHz时基除以4，生成一个新的时钟。
- **80 MHz时基**—主时基的板载时钟源，由此派生出其他时基。
- **100 MHz时基**—主时基的板载时钟源，由此派生出其他时基。
- **100 kHz时基** —通过将20 MHz除以200形成的时钟。

##### 2.2.1.2 采样定时类型

NI-DAQmx引入了*采样定时类型*的概念。每种定时类型都是激励信号生成的不同方式。通过“定时”函数/VI选择采样定时类型。也可通过属性设置下列采样定时类型：

- **采样时钟**—产生各个采样的数字边沿。几乎所有的设备都有一个专门的板载时钟用于周期性产生这些边沿。当时钟源不是专用的板载时钟时，边沿可能是非周期性的。即使边沿是非周期性的，仍需使用采样时钟定时。采样时钟定时是硬件定时的一种。

- **按要求**—每次读取或写入函数/VI执行时，设备尽快生成所需的采样。在该模式下，采样质量属性被忽略。按需采集是一种软件定时。

- 检测更改

  —当NI-DAQmx在数字线或数字端口检测到改动（上升沿、下降沿或两者兼而有之），改动检测定时从数字物理通道采集样本。改动检测定时减少了应用程序需处理的数字数据。在某些设备上需注意改动检测造成的过溢。NI-DAQmx在下一次改动检测事件之前无法读取采样，即会发生过溢。造成一个或多个采样丢失。

  使用“改动检测定时”函数/VI，指定要检测改动的上升沿和下降沿。任务开始后，可使用过溢属性查询是否有过溢发生。

- **握手**—握手采样定时类型用于通过8255协议采集或生成数字数据。许多设备具有8255芯片，部分仿8255协议的设备默认支持握手定时类型。

- **突发握手**—突发握手定时在数据线上使用时钟协议采集或生成数字数据。该定时类型有三种控制信号：采样时钟、暂停触发和传输就绪事件。如外围设备置暂停触发无效，DAQ设备置“传输就绪”事件有效，每个活动采样时钟边沿均会发生数据传输。

  根据是否导入或导出采样时钟，可以有单独的突发握手事件函数/VI。因为在两台设备之间共享时钟会有诸多限制（例如，设置和保持时间），所以选用合适的函数/VI较为重要。

- **隐式**—隐式采样模式用于使用计数器采集周期或频率采样。也用于生成脉冲。定时类型被称为*隐式*，因为待测量的信号是定时信号本身，或定时在生成的脉冲序列中是隐式的。

###### 2.2.1.2.1 采样时钟

设备使用采样时钟控制采集样本和生成样本的速率。采样时钟设置两个采样之间的时间间隔。时钟的每次计时周期都在每个通道上开始一次采样或生成一个采样。也可将外部时钟源作为采样时钟。在软件中，可通过指定采样率来指定间隔（时钟采集或生成信号的速度）。采样率可通过对信号进行调理或调整应用程序中的通道数来限制。但是，只有当采样率接近设备的最大采样率时，通道数才会影响到测量。

###### 2.2.1.2.2 握手

如要通过交换信号实现与外部设备通信，请求和确认数据传输，可使用握手信号。

例如，需从扫描仪获取一个图像。整个过程分为下列步骤：

1. 扫描仪扫描图像并传输数据就绪后发送一个脉冲至测量设备。
2. 测量设备读取8位、16位或32位数字采样。
3. 测量设备发送一个脉冲至扫描仪，告知扫描仪数字采样读取完毕。
4. 扫描仪准备发送另一个数字采样时再发送一个脉冲。
5. 测量设备接收到该数字脉冲后，设备开始读取采样。

上述过程重复执行直到采样全部传输完毕。

**突发握手信号**

支持突发握手定时的设备使用下列三个信号：

- 暂停触发（旧称：REQ）
- 传输事件就绪（旧称：ACK）
- 采样时钟

对于数字输入任务，暂停触发信号为逻辑低，传输就绪为逻辑高，采样被发送至测量设备。对于数字输出任务，暂停触发信号为逻辑低，传输事件就绪为逻辑高，采样被发送至测量设备。采样时钟，无论是板载的，还是外部的，都用于控制定时机制。数据传输或采集载采样时钟的上升沿或下降沿发生。

突发握手信号的默认接线端因设备而异。

**仿8255协议设备的握手信号**

仿8255协议设备支持两种握手信号：

- **握手触发**—也称为选通脉冲输入(STB)和确认输入(ACK)。
- **握手事件**—也称为输入缓冲区满(IBF)和输出缓冲区满(OBF)。

对于输入任务，当握手触发信号为低，采样被发送至测量设备。当发送采样后，握手触发为高，即告知周围设备数据已被读取。对于数字输出，NI-DAQmx设备发送采样至外围设备时握手事件为低。外围设备接收到采样后发送低脉冲至握手触发线。关于数字端口的握手信号配置的详细信息，请参考设备的说明文档。

握手信号的默认接线端因设备而异。

**8255设备的握手信号**

握手通信的8255设备支持下列四种握手信号：

- 选通脉冲输入(STB)
- 输入缓冲区满(IBF)
- 输出缓冲区满(OBF)
- 确认输入(ACK)

STB和IBF信号用于数字输入操作，OBF和ACK信号用于数字输出操作。当STB线为低时，采样被发送至测量设备。当发送采样后，IBF为高，即告知周围设备数据已被读取。对于数字输出，当软件发送采样至外围设备时，OBF为低。外围设备接收到采样后发送低脉冲至ACK线。关于数字端口的握手信号配置的详细信息，请参考设备的说明文档。

多个端口上的数字数据：

对于8255设备，任务中的端口决定使用哪条握手线。始终使用任务中高阶端口相关的握手线。例如，如将端口1和端口2组合至一个任务，使用与端口2相关的握手线。

如端口用于数字输入，则将所有STB线连接起来，如下图所示。将任务中最高阶端口的IBF线连接至其他设备。其他端口的IBF信号无需连接。

image

如在8255设备上组合数字输出的端口，仅连接端口列表中最后一个端口的握手信号，如下图所示。

image

进行握手通信时，一些数字线自动被预留为用于控制，无法使用。使用哪条控制线取决于当前使用的端口和握手通信的通道（输入或输出）。端口中未用于控制的其他数字线仍可使用。如在握手任务中通过任意线传输数据，整个端口都被预留为握手数据，端口中的其他线无法使用。



#### 2.2.2 触发

NI-DAQmx控制的设备进行的动作，称为操作。常见的操作包括生成一个采样、开始一个波形采集。每个NI-DAQmx操作都需要一个激励或原因。操作在激励发生时进行。这个激励就是触发。触发根据其引发的操作命名：

- 前移触发
- 到期触发
- 握手触发
- 暂停触发
- 参考触发
- 开始触发
- 准备开始触发

除了要指定触发引起的操作之外，还必须选择触发的类型，即如何产生这个触发.

##### 2.2.2.1 前移触发

前移触发是使开关设备执行扫描列表中下一个操作的触发。可将前移触发配置为在数字信号的边沿或“发送软件触发”函数/VI运行时发生。

##### 2.2.2.2 开始触发就绪

配置开始就绪触发时，计数器任务不会响应任何开始触发，直至发生开始就绪触发。配置该触发在数字边沿或在指定时间触发（支持时间触发的设备）。开始触发就绪独立于开始触发，通常用于高级的计数器/定时器应用。用户可使用开始触发就绪同步多个任务。例如，计数边沿和脉冲生成。然后，开始触发将用于开始采集或生成。

##### 2.2.2.3 到期触发

到期触发将使看门狗任务到期。可使用该触发代替看门狗定时器来表示时间到期。可将该触发配置为在数字信号边沿发生。

##### 2.2.2.4 握手触发

握手触发是来自外围设备的控制信号。外围设备发送握手信号告知DAQ设备已采集到一个采样（输入任务）或已生成一个采样（输入任务）。对于输入任务，默认在采样输入数据条件属性指定的触发位置，或周围设备置握手触发有效时DAQ设备锁住数据。

##### 2.2.2.5 暂停触发

在采样时钟定时或突发握手定时下，暂停触发用于暂停一个正在进行的采集或生成。置该触发无效即重新开始采集或生成。使用暂停触发的注意事项因设备而异。

##### 2.2.2.6 参考触发

参考触发在一组输入采样中创建参考点。可将该触发配置为在一个数字边沿、数字信号、模拟边沿或模拟信号进入或离开窗体区域时发生。在参考点前采集的数据为预触发数据。在参考点前采集的数据为预触后数据。

![GUID-617DB6FC-57B7-426F-82C7-CD90EBE741E5-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-617DB6FC-57B7-426F-82C7-CD90EBE741E5-5.5x8.5 - a5.png)

##### 2.2.2.7 开始触发

开始触发开始采集或生成。将该触发配置为在数字边沿、数字信号、模拟边沿、模拟信号进入或离开窗或在指定时间（支持时间触发的设备）触发。

##### 2.2.2.8 触发类型

除了要指定触发引起的操作之外，还必须选择触发的类型，即如何产生这个触发。如要触发一个模拟信号，使用模拟边沿触发或模拟窗触发。如要触发一个数字信号，请选择数字边沿触发，源通常为PFI管脚。

###### 2.2.2.8.1 模拟边沿触发

对于模拟边沿触发，可以配置测量设备查找特定的信号电平和斜率（上升或下降）。设备识别触发条件后执行与触发关联的指定动作。例如，开始测量或标记生成触发时获取哪个采样。将模拟触发信号连接到任意模拟输入通道或可接受模拟信号的接线端。其他信息，请参阅特定于设备的模拟触发注意事项。

在下图中，当信号达到3.2时，触发被设置为捕捉上升沿信号的数据。

![GUID-7089A4AE-6509-44C7-88E2-4107C85A2812-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-7089A4AE-6509-44C7-88E2-4107C85A2812-5.5x8.5 - a5.png)

滞后在触发基准之上或之下加窗，通常用于减少信号中噪声或毛刺造成的伪触发。如在上升斜坡使用滞后窗，当信号低于**电平**（或**阈值电平**）减去**滞后**并越过**电平**，触发置为有效。当信号低于**电平**减去**滞后**时，触发置为无效。

例如，添加大小为1的**滞后**到上一个使用3.2**电平**值的范例，信号必须在等于或小于2.2处才能开始触发。当信号高于3.2时，触发置为有效；信号低于2.2时，触发置为无效。

![GUID-1119E349-ECE0-4E44-AAD6-0F2F25BAE19D-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-1119E349-ECE0-4E44-AAD6-0F2F25BAE19D-5.5x8.5 - a5.png)

如在下降斜坡使用滞后窗，当信号高于**电平**（或**阈值电平**）加上滞后并越过**电平**，触发置为有效。当信号高于**电平**加上**滞后**时，触发置为无效。如果改为在3.2下降沿触发且滞后为1，信号必须在等于或高于4.2处开始，然后降至低于3.2以开始触发。当信号低于3.2时，触发置为有效；信号高于4.2时，触发置为无效。

![GUID-2BC989E6-6611-4990-8283-C79FDDA73E8D-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-2BC989E6-6611-4990-8283-C79FDDA73E8D-5.5x8.5 - a5.png)

###### 2.2.2.8.2 模拟电平触发

模拟电平触发类似于模拟边沿触发。无论是哪种触发，都需指定边沿（上升沿或下降沿）和触发电平。模拟边沿触发关注触发条件满足时的点。模拟电平触发关注信号位于触发电平之上或之下的*持续时间*。**模拟电平触发通常用作暂停触发**。暂停触发在触发条件满足时置动作有效或无效。下图显示了当信号超过触发电平时触发生效和信号低于触发电平时触发失效的两个过程。触发失效类似于暂停触发。

![GUID-DF2CE9B5-462D-4A9F-BB30-4D6F9E49E64A-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-DF2CE9B5-462D-4A9F-BB30-4D6F9E49E64A-5.5x8.5 - a5.png)

###### 2.2.2.8.3 模拟多边沿触发

模拟多边沿触发功能类似于模拟边沿触发。模拟多边沿触发的不同之处在，可将在同一任务中采集的多个通道源配置为各自具有独立的模拟触发条件。当多个通道源中的任一满足关联条件时，生成触发且设备将执行与该触发关联的指定动作。

###### 2.2.2.8.4 模拟窗触发

窗触发在模拟信号进入或离开两个电压值定义的窗时发生。设置窗的上限值和下限值指定窗的上下沿。下图显示了信号进窗后开始采集数据的触发。

![GUID-B6AC9687-2846-4937-BD00-41E17D1C32F6-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-B6AC9687-2846-4937-BD00-41E17D1C32F6-5.5x8.5 - a5.png)

下图显示了信号离开窗后开始采集数据的触发。

![GUID-6E25E6DB-BAF5-427D-967C-29A4779B545A-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-6E25E6DB-BAF5-427D-967C-29A4779B545A-5.5x8.5 - a5.png)

###### 2.2.2.8.5 数字边沿触发

数字边沿触发通常是一个有两个离散电平的TTL信号：高电平和低电平。当信号从高到低，或从低到高时，即产生了一个数字边沿。数字边沿有两种，上升沿和下降沿。可在数字信号的上升沿或下降沿产生开始或参考触发。

下图显示了数字触发信号下降沿后开始的采集。一般情况下，数字触发信号连接至测量设备的PFI管脚。

![GUID-394FA00F-F0B9-412A-B5F7-64C2254E647F-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-394FA00F-F0B9-412A-B5F7-64C2254E647F-5.5x8.5 - a5.png)

###### 2.2.2.8.6 数字电平触发

数字电平触发根据数据线上读取的值来开始、停止或暂停采集或生成

###### 2.2.2.8.7 数字模式触发

数字模式触发就是将设备配置为在特定物理通道上检测一个特定形状的数字信号。检测到条件后，设备将执行触发相关的动作，例如，开始一个任务或标记触发发生时采集到的信号。

数字信号通过下列字符定义：

- X：忽略物理通道
- 0：匹配物理通道上的逻辑低值
- 1：匹配物理通道上的逻辑高值
- R：匹配物理通道上的上升沿
- E：匹配物理通道上的上升沿或下降沿
- F：匹配物理通道上的下降沿

例如，如指定数字信号模式为"X11100"，源为"dev1/line0:4,dev1/line6,"，当物理通道"dev1/line1"、"dev1/line2"和"dev1/line3"为逻辑高，"dev1/line4"和"dev1/line6"是逻辑低时，发生模式匹配。"dev1/line0"被忽略。

![GUID-E2F09938-9837-4F02-8F79-9954BA7A20FC-5.5x8.5 - a5](/Users/zhangyuxiang/Documents/NI-DAQmx-Tutorial/image/GUID-E2F09938-9837-4F02-8F79-9954BA7A20FC-5.5x8.5 - a5.png)

对于端口上的模式触发，模式匹配按相反的顺序发生。例如，如指定数字信号模式为"11000000"，源为"dev1/port0"，当物理通道"dev1/line0"和"dev1/line1"为逻辑高，其他6条线为逻辑低时，发生模式匹配。

###### 2.2.2.8.8 软件触发

软件触发根据发送的软件触发命令，开始、停止或暂停一个采集或生成，或前移一个扫描列表项。使用“DAQmx发送软件触发”函数/VI生成一个软件触发命令。

###### 2.2.2.8.9 时间触发

对于支持的设备，时间触发器在指定时间暂停采集或测量。如果指定的时间已过，将弹出一条错误消息指示该时间已过。

时间标识的时间缩放可通过Timestamp.Timescale属性配置。时间触发和时间标识可根据应用程序的需要，在I/O设备时间或主机时间中指定。

- I/O设备时间

  由您的802.1AS子网上的所有网络同步设备共享。I/O设备时间对于在多个机箱间同步事件或从多个机箱关联时间标识最为有用，因为即使它可能处于不确定的时间缩放（例如，与很久以前的时间点相关，如Linux系统中的1970年代），它会删除与Windows系统时间或未与同一802.1AS子网网络同步的系统相关的其他偏移源。这样，它提供了最佳的时间触发和时间标识精度，但是，若它未关联至可识别的全局时间，则可能降低可用性。I/O设备时间还具有单调递增的优点，因此，跨多个设备或任务分布的时间触发和时间标识可准确地保持彼此间的偏移。

- 主机时间

  您的PC或NI Linux Real-Time控制器使用的时间缩放。若NI Linux Real-Time控制器是802.1AS子网的主机，则主机时间和I/O设备时间相同。但是，主机时间通常与本地实时时钟或网络时间协议服务器同步，并通常可追溯至全局时间。使用主机时间更直观，因为机箱上的触发和时间标识被指定的时间可容易地关联至您的本地系统时间。但是，这种可用性的代价是降低了在多个设备或任务间分布的时间触发和时间标识之间的相对准确性，因为在两个时间缩放之间使用计算的偏移量不如直接使用I/O设备时间那么精确。为了在特定和常见用例中补偿该精度损失，NI-DAQmx保证调度用于相同主机时间的两个事件在相同的I/O设备时间启动，以保持机箱之间的精确同步。

  您可使用**TimeTrigSupported**属性查询设备是否支持时间触发。

  网络同步设备包括cDAQ-9185、9189；FD-11601、FD-11603、FD-11605、FD-11613、FD-11614、FD-11634、FD-11637；cRIO-9040、9041、9042、9043、9045、9046、9047、9048、9049、9053、9054、9055、9056、9057、9058；以及sbRIO-9603、9608、9609、9628、9629和9638。

#### 2.2.3 同步

同步操作通过连接定时信号和控制信号实现。同步操作可以是在一台设备上或多台设备上。例如，在同一台M系列设备上同步模拟输入和模拟输出。同步操作的定时和控制信号分为三类：时钟、触发和事件。

通过连接两个接线端形成时间和控制信号的回路。选择接线端作为时钟或触发的源。在PCI设备上，RTSI总线可用于信号连线。在PXI设备上，PXI触发总线提供连线。要使NI-DAQmx查找到一条闲置的PXI触发线，必须在MAX中进行PXI机箱识别。要使NI-DAQmx查找到一条闲置的RTSI线，必须在MAX中创建一条RTSI线缆，然后将其应用于线缆连接的设备。MAX中的连线图给出了设备上可能的连线方案。

在一些设备上，将多个模块上的模拟输入、模拟输出和数字输入/输出通道加入同一个任务中，可同步多个通道。任务中的所有通道的类型必须相同，例如，模拟输入、计数器输出，等等。

##### 2.2.3.1 同步的类型，锁步和握手

锁步是指两个或两个以上相似的设备共享定时和触发，并作为一个设备使用。在同一台设备的模拟输入和模拟输出上使用相同的采样时钟也是锁步。锁步是为了尽量减少偏度。在锁步中，时钟和触发通常是共享的。

握手同步（激励/响应）用在多台设备按顺序执行的情况。在握手同步中，触发和事件通常是共享的。例如，简化的DAC测试。数字设备发送一个数字信号到数模转换器，然后一个信号使数模转换器产生一个响应电压。几乎在同时，数字设备发送信号至DMM，DMM测量数模转换器输出的电压。DMM完成测量后发送信号至数字设备，使数字设备发送下一个信号至数模转换器。

在锁步同步中，所有操作均使用一个时钟或触发。在握手同步中，触发或事件在两个操作之间被保留（例如，DMM的采样完成事件被接收该事件的数字设备作为采样时钟）。

##### 2.2.3.2 主设备和伺服设备

大多数同步应用会使用其他设备的信号。例如，采样时钟同步的设备会使用来自其他设备的采样时钟。参考时钟同步不是直接使用设备的板载时钟，而是将板载时钟锁入共享时钟，所有设备将使用某台设备上的开始触发。

提供信号的设备叫做主设备，应用程序中其他使用该信号的设备叫做伺服设备。主设备提供所有信号，任务一开始主设备就开始采集生成样本。**伺服设备直到接收到主设备的信号后才开始采集或生成数据**。因此，**开始主设备上的任务之前必须先开始伺服设备上的任务**。任务在伺服设备上开始后，即开始等待主设备发出的信号。然后，任务在主设备上开始，主设备发送同步信号，保证所有设备同时采集或生成样本。如在开始伺服设备任务之前开始主设备上的任务，伺服设备上任务开始之前主设备采集或生成的数据的时间具有不确定性。在上述情况下应用程序没有实现同步，会产生错误。

##### 2.2.3.3 错误源

同步测量时，有下列错误源：

- 抖动
- 稳定性
- 精度
- 偏度

###### 2.2.3.3.1 抖动

抖动是时钟周期之间（两次采样之间）的微小差别。抖动反映为数字化信号中的噪声，对高频信号影响更大。在时钟路径上添加各种元器件均会导致抖动。**使用精确的时钟源可以减少抖动，但是不能彻底消除抖动。****

###### 2.2.3.3.2 稳定性

稳定性指的是时钟抵抗频率波动的程度。可产生频率波动的因素包括温度、时间、电压、扰动、震动、电容负载，等等。温度是影响晶振稳定性的最主要因素。

有些晶振被置于恒温外壳内，以确保稳定性处于一个合理的范围。这些晶振也称为恒温控制晶体振荡器(OCXO)。例如，NI 6608中包括一个OCXO。

###### 2.2.3.3.3 精度

时钟精度指时钟的实际频率与指定频率的匹配度。时钟频率由振荡器产生。但是，振荡器产生的频率不是绝对精确的频率。振荡器时钟的精度受晶振和振荡器组装方式的影响。

描述计时错误有各种不同的方式。常见的计时错误有ppm（百万分之一）和ppb（十亿分之一）。百万分之一描述错误的概率。例如，如要找出错误为5 ppm的80 MHz振荡器出错概率，必须将振荡器频率(80,000,000)乘以5，然后除以1,000,000。如下列等式所示：80,000,000 Hz (5 Hz/1,000,000 Hz) = 400 Hz。

从上述等式中可知，振荡器错误的频率是400 Hz。时钟的实际频率为79,999,600 Hz - 80,000,400 Hz之间。ppb与ppm类似，用于描述更高精度的时钟频率。

###### 2.2.3.3.4 偏度

偏度是信号在不同时刻到达两个不同位置时产生的传输延迟。例如，控制设备在T0时刻发送信号。接收设备A在T1时刻产生反应。接收设备B在T2时刻产生反应。如T1不等于T2，这其中的差别就是偏度。设备间距、设备间连线和设备上的信号路径都会影响信号的达到时间。

##### 2.2.3.4 同步的方法

根据设备和应用程序需求，有下列同步方法可供选择：

- 开始触发
- 采样时钟
- 参考时钟
- 主时基
- 采样时钟时基
- 混合时钟

###### 2.2.3.4.1 开始触发	

###### 2.2.3.4.2 采样时钟

###### 2.2.3.4.3 参考时钟

###### 2.2.3.4.4 主时基

###### 2.2.3.4.5 采样时钟时基

###### 2.2.3.4.6 混合时钟

##### 2.2.3.5 计数器同步

##### 2.2.3.6 触发延时矫正

#### 2.2.4 子系统

#### 2.2.5 定时引擎

#### 2.2.6 事件

#### 2.2.7 导出信号动作

#### 2.2.8 软件事件



### 2.3 读取和写入数据

### 2.4 信号连线

### 2.5 计数器

### 2.6 接线端

### 2.7 强制转换

### 2.8 校准

### 2.9 NI-DAQmx中的控制

### 2.10 NI-DAQmx仿真设备

### 2.11 分布式应用

#### 2.11.1 电压生成的外部参考源

#### 2.11.2 自定义换算



## 3. NI-DAQmx设备注意事项



## 4. DAQmx - 数据采集节点



## 5. DAQmx属性



