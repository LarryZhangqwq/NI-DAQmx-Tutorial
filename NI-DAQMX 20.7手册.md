# NI-DAQMX 20.7手册

## 0. 入门

### 0.1 NI-DAQmx概述

NI-DAQmx是用于与NI数据采集(DAQ)设备通信并控制设备的驱动程序软件。它包含一个用途广泛的函数和VI库，可从LabVIEW或LabWindows/CVI中调用库函数，对NI设备进行编程。

Measurement＆Automation Explorer (MAX)和DAQ助手是随NI-DAQmx自动安装的应用程序。

可在在MAX或LabVIEW、SignalExpress、LabWindows/CVI、Measurement Studio等NI应用软件中打开DAQ助手。通过DAQ助手，可︰

- 创建和编辑任务及虚拟通道
- 向任务添加虚拟通道
- 创建和编辑换算
- 测试自定义配置
- 保存自定义配置
- 在NI应用软件中生成代码以用于自定义应用程序。
- 查看传感器的连线图。

### 0.2 查找范例

每个API均提供一组编程范例，以方便用户开发应用程序。用户可修改范例代码，然后将代码保存在应用程序中。用户可使用范例开发新的应用程序，或将范例添加至现有应用程序中。

使用NI-DAQmx仿真设备，无需安装硬件就可以运行范例。在MAX中，选择帮助 -> 帮助主题 -> NI-DAQmx，查看*NI-DAQmx的MAX帮助*，获取更多关于NI-DAQmx仿真设备的信息。

### 0.3 疑难解答

* https://www.ni.com/documentation/zhs/ni-daqmx/20.1/gettingstarted/troubleshooting/

## 1. 测量基础

### 1.1 测量系统概述－硬件和NI-DAQmx

<img src="/image/GUID-9D481B1D-EACA-4873-8632-99D6F735613E-5.5x8.5 - a5.png" alt="GUID-9D481B1D-EACA-4873-8632-99D6F735613E-5.5x8.5 - a5" style="zoom: 67%;" />

NI-DAQmx驱动软件中包含的应用软件可用于对NI测量设备编程（例如，配置、采集、生成和发送数据至NI测量设备）。使用NI-DAQmx可节省编程时间。应用程序（例如，LabVIEW、LabWindows™/CVI™和Measurement Studio）发送命令至驱动软件。例如，获取和返回热偶的读取值并显示和分析得到的数据。

通过NI应用软件或支持使用ANSI C接口调用动态链接库(DLL)的编程环境，可调用NI-DAQmx驱动程序。在任意编程环境中，DAQ应用均使用NI-DAQmx。

### 1.2 信号类型

<img src="/image/GUID-20D703F9-19D5-4B1D-88DC-04281846846B-5.5x8.5 - a5.png" alt="GUID-20D703F9-19D5-4B1D-88DC-04281846846B-5.5x8.5 - a5." style="zoom: 100%;" />

#### 1.2.1 模拟信号连接注意事项

**测量模拟信号前，必须确定信号源为接地或浮接，还必须考虑测量系统为差分、参考单端或非参考单端。**

* [接地信号源](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/groundsig/#GUID-A41EE540-F1EF-46F8-9D86-B72704F24216)
* [浮接信号源](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/floatsig/#GUID-EAC91D96-DE8A-47B7-BBEF-B53B37B190C2)
* [差分测量系统](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/diffmeassys/)
* [参考和非参考单端测量系统](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/refsingleended/)

#### 1.2.2 连接模拟输入信号

### 1.3 信号调理

传感器可生成用于测量物理现象（例如，温度、力、声音和光）的电信号。如需测量传感器的信号，必须将其转换为DAQ设备可读取的格式。例如，热电偶的输出电压很小且易被噪声干扰。因此，在转换为数字信号前，必须进行放大和滤波处理。

使信号适合数字化的过程称为*信号调理*。信号调理通常包括：放大, 线性化, 传感器激励, 隔离

#### 1.3.1 放大

通过增大信号相对于噪声的幅度，提高数字化信号的精度。使最大电压变化等于ADC或数字化仪的最大输入范围，可获得尽可能高的准确性。系统应通过最接近信号源的测量设备放大低电平信号。

<img src="/image/GUID-3865E721-F72F-46FF-8CF2-512BB75F12F4-5.5x8.5 - a5.png" alt="GUID-3865E721-F72F-46FF-8CF2-512BB75F12F4-5.5x8.5 - a5." style="zoom: 100%;" />

如通过测量设备放大信号，则测量和数字化的信号中可能包含由导线引入的噪声。在接近信号源的位置通过SCXI模块放大信号，可减少噪声对被测信号的影响。

**Note: 应使用屏蔽式电缆或双绞线电缆。通过减小电缆长度可降低导线引入的噪声。使信号连线远离AC电源电缆和显示器可减少频率为50至60 Hz的噪声。**

#### 1.3.2 线性化

通过软件使传感器产生的信号线性化，换算后的电压可用于物理现象。例如，通常，热电偶10 mV的电压变化并意味着温度的变化为10。但是，通过软件或硬件的线性化处理，应用中的热电偶值可换算为相应的温度变化。绝大多数传感器具有用于说明传感器换算关系的线性化表格。

#### 1.3.3 传感器激励 

信号调理系统可为某些传感器生成激励。应变计和RTD需要外部电压和电流激励电路，然后开始测量物理现象。激励类似于收音机用于接收和解码音频信号所需的电源。许多测量设备可为传感器提供激励。关于设备是否可生成激励，见设备文档

#### 1.3.4 隔离

信号通常会超出测量设备可处理的范围。尝试测量过大的信号可导致测量设备损坏或人身伤害。通过*隔离*信号调理技术可防止人体和测量设备接触过大的电压。信号调理硬件可降低较高的共模电压，获取测量设备可处理的电压信号。通过隔离可避免接地电势差对设备的影响。

### 1.4 常见传感器

不同的应用使用不同的传感器。常见的传感器包括：应变计、热电偶、热电阻、角度编码器、线性编码器、基于电桥的传感器以及电阻式温度检测器(RTD)。

* https://www.ni.com/documentation/zhs/ni-daqmx/20.1/measfunds/cmmnsensor/

### 1.5 控制概述

通常，控制应用中包含一个或多个需控制的过程变量（例如，温度）。传感器可测量动态系统中的过程变量并为应控制应用提供数据。设定点为过程变量要达到的值。比较器可判断过程变量和设定点之间的差。如差不为零且系统判断该值足够大， 补偿器可处理该值并通过执行器的输出驱动系统接近设定点。

<img src="/image/GUID-74BFB5ED-CE8E-4CB7-8436-830393A22A26-5.5x8.5 - a5.png" alt="GUID-74BFB5ED-CE8E-4CB7-8436-830393A22A26-5.5x8.5 - a5" style="zoom: 100%;" />

#### 1.5.1 比例积分微分(PID)

比例积分微分(PID)算法是工业中最常使用的控制算法。通常，PID用于加热和冷却系统、液面监控、流控制和压力控制应用。在PID控制中，必须指定过程变量和设定点。过程变量是要控制的系统参数（例如，温度、压力和流量），设定点是要控制的参数值。PID控制器可确定控制器的输出值（例如，加热器的功率或值位置）。控制器使用控制器输出值控制系统，使过程变量接近设定点的值。

#### 1.5.2 实时

实时是指及时响应。对于非实时系统，无法确定响应发生的时间，操作完成的时间可能早于或晚于预期时间。换句话说，实时系统具有确定性，可保证操作在指定时间内发生。实时系统是可预期的。

对于实时系统，所有部分都必须是实时的。例如，即使程序运行在实时操作系统上，也不意味着程序具有实时特性。程序可能依赖某些非实时动作（例如，文件I/O），导致程序无法实时运行。

#### 1.5.3 循环周期时间

许多应用（例如，控制应用）需使用周期性实时操作系统。周期的开始和结束之间的时间*T*称为*循环周期时间*或采样周期。1/T为循环速率或采样率。即使在实时操作系统中，循环周期也可能变化，但始终小于最大抖动。

#### 1.5.4 控制应用中的抖动

对于控制应用，循环时间与期望时间的差称为抖动。循环时间与期望时间差的最大值称为最大抖动。<img src="/image/GUID-50BF3221-1F1B-4804-8623-CABB7E7FE044-5.5x8.5 - a5.png" alt="GUID-50BF3221-1F1B-4804-8623-CABB7E7FE044-5.5x8.5 - a5" style="zoom:50%;" />

实时系统中的抖动是固定的。例如，安全气囊必须在碰撞发生后的1秒内打开，因此最大抖动为固定值。非实时系统中的抖动不是固定的，变化范围较大。例如，等待公交车。按照计划，公交车应在上午11:00到达，但实际到达时间第一天为上午11:05，第二天为上午11:30，第三天无法到达。对公交车的延误时间没有限制。

#### 1.5.5 事件响应

事件响应应用需要在确定的时间内对发生的事件进行响应。例如，监视引擎的温度。在引擎温度过高时，降低引擎运行的速度。事件是指引擎温度超出预设上限，响应是指降低引擎运行速度。另一个实例来自生产制造过程。在生产线上，系统在检测到零件将要进行一道工序（事件）时，将获取读数或对零件执行操作（响应）。如系统在一段时间内没有检测到零件或没有对零件的出现产生响应，生产线将产生次品零件。

## 2. NI-DAQmx重要概念

### 2.1 NI-DAQmx通道和任务

* **虚拟通道（通道）**，是将实体通道和通道相关信息（范围、接线端配置、自定义换算等格式化数据信息）组合在一起的软件实体。任务是具有定时、触发等属性的一个或多个虚拟通道。
  * 通过“DAQmx创建虚拟通道”函数/VI创建的虚拟通道是局部虚拟通道，只能在任务中使用。使用该函数，可选择虚拟通道的名称。该名称将用于NI-DAQmx的其他位置，用于指代该虚拟通道。
  * 如使用DAQ助手创建虚拟通道，可在其他任务中使用这些虚拟通道，并在任务之外引用虚拟通道。因为这些虚拟通道是全局虚拟通道，可用于多个任务。可使用NI-DAQmx API或DAQ助手选择全局虚拟通道，并将其加入至任务。如将一条全局虚拟通道添加至若干个任务，然后使用DAQ助手修改这个全局虚拟通道，改动将应用于所有使用该全局虚拟通道的任务。全局虚拟通道的改动生效前必须先保存改动。
* **实体通道**是测量和发生模拟信号或数字信号的接线端或管脚。信号物理通道可包括一个以上接线端，例如，差分模拟输入通道，或8线数字端口。设备上的每个实体通道都有唯一的符合NI-DAQmx实体通道命名规范的名称（例如，SC1Mod4/ai0, Dev2/ao5, Dev6/ctr3）。

#### 2.1.1 通道：物理、虚拟、局部虚拟和全局虚拟

##### 2.1.1.1 使用API创建虚拟通道

**问题：**

创建一个NI-DAQmx虚拟通道，测量50° C - 200° C之间的温度。将M系列设备配置为Dev1，将J型热电偶连接至设备上的通道0。使用LabVIEW或LabWindows™/CVI™写一个应用程序。

**解答：**

1. 调用LabVIEW中的“DAQmx创建虚拟通道”VI的AI温度TC实例在LabWindows/CVI中是``DAQmxCreateAIThrmcplChan``函数）。
2. 使用设备上的``Dev1/ai0``作为连接热电偶信号的实体通道。
3. 指定虚拟通道的名称为``myThermocoupleChannel``。
4. 选择相应的热电偶类型和范围输入值。NI-DAQmx将把这些属性应用至虚拟通道。

##### 2.1.1.2 虚拟通道的类型

根据信号的类型（模拟、数字、计数器）和方向（输入、输出），可创建不同类型的虚拟通道。虚拟通道可以是全局虚拟通道或局部虚拟通道。关于函数/VI的详细信息，请参考ADE的相关帮助。

- **模拟输入通道**—模拟输入通道使用各种传感器测量不同的物理现象。创建的通道类型取决于传感器以及测量现象的类型。例如，可创建热电偶测量温度的通道、测量电流电压的通道、测量带激励电压的通道，等等。

- **模拟输出通道**—NI-DAQmx支持两种类型的信号，电流信号和电压信号。如设备测量的是其他信号，可将测得的信号进行转换得到电压或电流信号。

- **数字输入/输出通道**—对于数字通道，可创建基于线和基于端口的数字通道。基于线的通道可包含设备一个或多个端口的一条或多条数字线。读取护哦些如基于数字线的通道不会影响硬件上的其他数字线。可将一个端口中的数字线在多条通道中使用，并在一个或多个任务中同时使用这些通道，但是某条通道中的线必须全是输入线或输出线。另外，任务中的所有通道必须是输入通道或输出通道。有些设备还规定端口中的线必须都是输入线或输出线。关于设备的详细信息，请查阅设备文档。

  基于端口的通道表示设备上的一组数字线。读取或写入端口将影响端口中的所有数字线。端口中所有线的数量（端口宽度）是一个硬件参数，通常从8线（MIO设备）到32线（SCXI数字模块）不等。

- **计数器输入/输出通道**—NI-DAQmx支持不同计数器测量和生成类型的输入和输出。关于计数器测量的常见应用，见NI-DAQmx中计数器的组成。

##### 2.1.1.3 物理通道语法

###### 物理通道名称

物理通道的名称有**设备标识符、斜杠(/)和通道标识符**组成。例如，如物理通道是``Dev1/ai1``，设备标识符是``Dev1``，通道标识符是``ai1``。MAX根据设备在系统中安装顺序的前后为设备分配标识符，例如，``Dev0、Dev1``等等。也可在MAX中为设备分配设备标识符。

对于模拟I/O和计数器I/O，通道标识符由通道类型（**模拟输入ai，模拟输出ao，计数器ctr**）和通道编号组成，如下所示：``ai1 ctr0``

对于数字I/O，通道标识符指定了一个端口，包括了端口中的所有线：``端口0``

通道标识符可指定端口中的线：``port0/line1``

所有线都具有唯一的标识符。所以，不用说明线归属的端口即可指定一条数字线。例如，在有4个8位端口的设备上，``line31``等同于``port3/line7``。

###### 物理通道范围

如要指定一个物理通道的范围，在两个通道编号或物理通道名称的编号之间使用冒号分隔：

``Dev1/ai0:4``or ``Dev1/ai0:Dev1/ai4``

对于数字I/O，在两个端口编号之间用冒号分隔，指定一个端口范围。

``Dev1/port0:1``

可指定一个数字线的范围：

``Dev1/port0/line0:4``

``Dev1/line0:31``

可反向指定通道范围：

``Dev1/ai4:0``

``Dev1/ai4:Dev1/ai0``

``Dev1/port1/line3:0``

###### 物理通道列表

使用逗号在列表中分隔物理通道名称和范围，如下所示：

``Dev1/ai0, Dev1/ai3:6``

``Dev1/port0, Dev1/port1/line0:2``

##### 2.1.1.4 数字线、端口和端口宽度

数字线和端口是数字输入/输出系统的重要部分。

- **线**—一条线就是一个独立的信号。线表示一个实体的接线端。线上的数据叫做“位”，是二进制的0或1。线和位基本上是可以互换的术语。例如，8比特端口与8线端口含义相同。
- **端口**—端口是数字线的集合。通常情况下，数据线都被组合为8位或32位端口。
- **端口宽度**—端口宽度指端口中线的数量。例如，一个8线端口的端口宽度为8。

##### 2.1.1.5 生成通道名称

通过NI-DAQmx API创建局部虚拟通道时，如用户不提供局部虚拟通道的名称，NI-DAQmx将会为通道自动分配名称

| 物理通道名称 | 分配的名称 | 生成的局部虚拟通道名称         |
| :----------- | :--------- | :----------------------------- |
| Dev1/ai0:1   | —          | Dev1/ai0, Dev1/ai1             |
| Dev1/ai0:7   | "foo"      | foo0, foo1, ..., foo7          |
| Dev1/ai0:7   | "foo31"    | foo31, foo32, ..., foo38       |
| Dev1/ai0:7   | "foo 123"  | foo123, foo124, ..., foo130    |
| Dev1/ai0:7   | "a0:3, b"  | a0, a1, a2, a3, b0, b1, b2, b3 |

##### 2.1.1.6 为通道、任务和换算命名

通道、任务和换算的命名需符合下列要求：

- 仅使用字母和数字字符。

- 不要使用非字母数字字符，下列特例除外：

  - NI-DAQmx 7.4及更高版本允许在通道、任务和换算的名称中使用连字符。
  - 允许使用空格。
  - 可在通道、任务或换算名称中使用下划线，但是下划线不能作为名称的首字符，如_Dev1。

  **注：**

  创建通道、任务和换算时，可使用其他非数字字母类字符。但是将配置导入其他系统，尤其是其他语言的系统时，配置可能失效。

- 设备名称不能多于256个字符。

##### 2.1.1.7 冷端补偿通道

内置的冷端补偿(CJC)通道。每经过一个采样时钟边沿，读取一次CJC通道。

相关主题：[采样时钟](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/sampclock/)

#### 2.1.2 NI-DAQmx任务

任务是一个或多个虚拟通道定时、触发等属性的集合。从概念上来说，任务就是信号测量或信号发生。任务中的所有通道的I/O类型必须相同，例如，模拟输入、计数器输出，等等。但是，任务可包含不同测量类型的通道，例如，测量温度的模拟输入通道和测量电压的模拟输入通道。对于大多数设备，一次只能运行子系统的一个任务；部分设备可同时运行多个任务。在一些设备上，一个任务中可以包括来自多台设备的通道。按照下列步骤进行测量或生成任务：

1. 创建或加载一个任务。可使用DAQ助手交互式创建任务，或在ADE（LabVIEW或LabWindows/CVI）中通过编程创建任务。
2. 如有需要，配置通道、定时和触发属性。
3. 如有需要，进行若干任务状态转换，使任务就绪。
4. 读取或写入采样。
5. 清除任务。

如实际需要，请重复步骤2至步骤4。例如，读取或写入采样后，可重新配置虚拟通道、定时和触发属性，然后根据新的配置读取和写入其他采样。

如要将属性设置为除默认值以外的其他值以保证任务成功执行，程序每次执行时都必须重新设置这些属性。例如，如运行的程序将属性A设置为非默认值，然后再运行一个不设置属性A的程序，第二个程序将使用属性A的默认值。避免该重复操作的唯一方法时使用DAQ助手创建虚拟通道和任务。

##### 2.1.2.1 通过API创建任务

**问题：**

创建一个NI-DAQmx任务测量50°C-200°C之间的温度，将M系列设备配置为设备1，连接J型热电偶至设备的通道0。每秒钟采集温度10次，采集10,000个数据。使用LabVIEW或LabWindows/CVI写一个应用程序。

**解答：**

1. 调用LabVIEW中的“DAQmx创建虚拟通道”VI的AI温度TC实例（在LabWindows/CVI中是``DAQmxCreateAIThrmcplChan``函数）。
2. 使用设备上的``Dev1/ai0``作为连接热电偶信号的物理通道。
3. 指定虚拟通道的名称为``myThermocoupleChannel``。
4. 选择相应的热电偶类型和范围输入值。NI-DAQmx将把这些属性应用至虚拟通道。
5. 调用LabVIEW中“DAQmx定时”VI的采样时钟实例（或LabWindows/CVI中的``DAQmxCfgSampClkTiming``函数），指定**采样率**为10 Hz，**采样模式**为有限(finite)采样。
6. 调用“DAQmx开始任务”VI（LabWindows/CVI中的``DAQmxStartTask``函数）。
7. 调用“DAQmx读取”VI的模拟1D DBL 1通道N采样实例（``LabWindows/CVI中的DAQmxReadAnalogF64``函数），指定**每通道采样数**为10,000。
8. 当采集完所需的样本数据后，调用“DAQmx停止任务”VI（LabWindows/CVI中的``DAQmxStopTask``函数）。
9. 调用“DAQmx清除任务”VI（LabWindows/CVI中的``DAQmxClearTask``函数）。

至此，使用局部虚拟通道``myThermocoupleChanne``l的``myTemperatureTask``任务创建完毕。

##### 2.1.2.2 使用“开始任务”函数/VI

调用“开始任务”函数/VI可显式地开始一个任务。进行其他隐式开始任务的操作时，任务会自动开始。例如，调用“读取”或“写入”函数/VI可能会隐式地开始一个任务。指定显式或隐式开始任务，取决于任务的操作。默认情况下，单点读取函数和写入函数会自动开始一个任务。

### 相关主题

- [“已就绪”状态](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/committedstate/)
- [“运行”状态](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/runningstate/)
- [任务状态模型](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/taskstatemodel/)
- [“已验证”状态](https://www.ni.com/documentation/zhs/ni-daqmx/20.1/mxcncpts/verified/)

**开始一个有限测量任务：**

* 如指定了执行有限测量的任务，则无需调用开始任务函数/VI，也不需要更改DAQmx读取函数/VI的默认行为。调用读取函数/VI开始任务并执行有限测量，并在读取最后一个采样后停止任务。调用读取操作前，任务返回其状态。但是，如要在任务结束后进行额外的读取操作（要读取缓冲区更早存入的数据），默认操作是不够的，原因有二：
  1. 任务返回至验证状态，无法访问采样。
  2. 再调用“读取”函数/VI会启动新的读取操作，而不是从完成的操作中继续读取。
* 在该情况下，调用控制任务函数/VI，将**动作**参数设置为“就绪”。然后，在进行初始读取操作之后和后续操作之前，将自动开始读取属性设置为FALSE。

##### 2.1.2.3 中止任务

#####  2.1.2.4 使用“任务完成”函数/VI

##### 2.1.2.5 使用“结束前等待”函数/VI

##### 2.1.2.6 任务何时完成？

#### 2.1.2.7 任务状态模型



### 2.2 定时和触发



### 2.3 读取和写入数据

### 2.4 信号连线

### 2.5 计数器

### 2.6 接线端

### 2.7 强制转换

### 2.8 校准

### 2.9 NI-DAQmx中的控制

### 2.10 NI-DAQmx仿真设备

### 2.11 分布式应用

#### 2.11.1 电压生成的外部参考源

#### 2.11.2 自定义换算



## 3. NI-DAQmx设备注意事项



## 4. DAQmx - 数据采集节点



## 5. DAQmx属性



